// The MIT License (MIT)
//
// Copyright (c) <2015> Itay Grudev <itay@grudev.com>
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
(function(b,g){function h(c,a){this.element=c;this.options=b.extend({},l,a);this.init()}function k(b,a,d){var e;return function(){var f=this,m=arguments;clearTimeout(e);e=setTimeout(function(){e=null;b.apply(f,m)},a)}}var l={map:g,multipleFields:g,latitudeSelector:".latitude",longitudeSelector:".longitude",viewportSelector:".viewport",zoomSelector:".zoom",errorSelector:".geocode-error",parent:"form",requestTimeout:800};h.prototype.init=function(){if("object"==typeof this.options.map)if(this.options.map=
b.extend({selector:g,defaultLatitude:0,defaultLongitude:0,defaultZoom:2,googleMapOptions:{}},this.options.map),this.options.map.selector!=this.options.map.selector)console.error("jquery.geocode: no map.selector provided");else{this.hasMap=!0;var c={},a;c.lat=parseFloat(b(this.element).closest(this.options.parent).find(this.options.latitudeSelector).val());c.lng=parseFloat(b(this.element).closest(this.options.parent).find(this.options.longitudeSelector).val());a=parseFloat(b(this.element).closest(this.options.parent).find(this.options.zoomSelector).val());
if(c.lat!=c.lat||c.lng!=c.lng)c={lat:this.options.map.defaultLatitude,lng:this.options.map.defaultLongitude};a!=a&&(a=this.options.map.defaultZoom);c=b.extend(this.options.map.googleMapOptions,{zoom:a,center:c});if(1==b(this.options.map.selector).length)a=b(this.options.map.selector)[0];else{var d;for(a=b(this.element);0<(a=a.parent()).length;)if(d=a.find(this.options.map.selector),1==d.length){a=d[0];break}}a instanceof jQuery?console.error("jquery.geocode: no elements found using provided map.selector"):
(this.map=new google.maps.Map(a,c),c=function(){var a=this;return k(function(){var f=a.map.getCenter();b(a.element).closest(a.options.parent).find(a.options.latitudeSelector).val(f.lat());b(a.element).closest(a.options.parent).find(a.options.longitudeSelector).val(f.lng());b(a.element).closest(a.options.parent).find(a.options.zoomSelector).val(a.map.getZoom());a.locationResolved=!0},100)}.apply(this),this.map.addListener("center_changed",c),this.map.addListener("zoom_changed",c))}"undefined"!=typeof this.options.multipleFields&&
(this.options.multipleFields=b.extend({addressLineSelector:".address-line",localitySelector:".locality",postalCodeSelector:".postal-code",countryCodeSelector:".country-code"},"object"==typeof this.options.multipleFields?this.options.multipleFields:{}),this.hasMultipleFields=!0);c=function(){var a=this;return function(){a.locationResolved=!1;a.geocodeDebounce.apply(a)}}.apply(this);if(1==this.hasMultipleFields)b(this.element).closest(this.options.parent).find(this.options.multipleFields.addressLineSelector).on("input change",
c),b(this.element).closest(this.options.parent).find(this.options.multipleFields.localitySelector).on("input change",c),b(this.element).closest(this.options.parent).find(this.options.multipleFields.postalCodeSelector).on("input change",c),b(this.element).closest(this.options.parent).find(this.options.multipleFields.countryCodeSelector).on("input change",c);else b(this.element).on("input",c);c=function(){var a=this;return function(b){a.locationResolved||(a.submitFormAfterResolution=!0,a.resolutionInProgress||
a.geocode(),b.preventDefault())}}.apply(this);b(this.element).closest(this.options.parent).submit(c);this.geocodeDebounce=k(this.geocode,this.options.requestTimeout);this.submitFormAfterResolution=this.resolutionInProgress=this.locationResolved=!1};h.prototype.geocode=function(){this.resolutionInProgress=!0;var c,a={};1==this.hasMultipleFields?(c=b(this.element).closest(this.options.parent).find(this.options.multipleFields.addressLineSelector).map(function(){return b(this).val()}).get().join(" "),
a.locality=b(this.element).closest(this.options.parent).find(this.options.multipleFields.localitySelector).map(function(){return b(this).val()}).get().join(" "),"undefined"!=typeof a.locality&&""!=a.locality||delete a.locality,a.postalCode=b(this.element).closest(this.options.parent).find(this.options.multipleFields.postalCodeSelector).val(),"undefined"!=typeof a.postalCode&&""!=a.postalCode||delete a.postalCode,a.country=b(this.element).closest(this.options.parent).find(this.options.multipleFields.countryCodeSelector).val(),
"undefined"!=typeof a.country&&""!=a.country||delete a.country):c=b(this.element).val();var d=new google.maps.Geocoder,e=function(){var a=this;return function(c,d){d==google.maps.GeocoderStatus.OK?(1==a.hasMap&&(a.map.fitBounds(c[0].geometry.viewport),a.map.setCenter(c[0].geometry.location)),b(a.element).closest(a.options.parent).find(a.options.latitudeSelector).val(c[0].geometry.location.lat()),b(a.element).closest(a.options.parent).find(a.options.longitudeSelector).val(c[0].geometry.location.lng()),
b(a.element).closest(a.options.parent).find(a.options.viewportSelector).val(JSON.stringify([c[0].geometry.viewport.getNorthEast().lat(),c[0].geometry.viewport.getNorthEast().lng(),c[0].geometry.viewport.getSouthWest().lat(),c[0].geometry.viewport.getSouthWest().lng()])),a.resolutionInProgress=!1,a.locationResolved=!0,1==a.submitFormAfterResolution&&b(a.element).closest(a.options.parent).submit(),b(a.element).closest(a.options.parent).find(a.options.errorSelector).hide()):(a.submitFormAfterResolution.resolutionInProgress=
!1,a.submitFormAfterResolution.locationResolved=!1,b(a.element).closest(a.options.parent).find(a.options.errorSelector).show())}}.apply(this);d.geocode({address:c,componentRestrictions:a},e)};b.fn.geocode=function(c){return this.each(function(){b.data(this,"plugin_geocode")||b.data(this,"plugin_geocode",new h(this,c))})}})(jQuery);
